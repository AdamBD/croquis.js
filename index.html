<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Croquispop</title>
    <link rel="stylesheet" type="text/css" href="./croquispop.css">
  </head>
  <body>
    <div id="tool-shelf">
      <span>손떨림 보정 단계: </span>
      <input id="tool-stabilize-level-slider" type="range" min="3" max="20">
      <span>무게: </span>
      <input id="tool-stabilize-weight-slider" type="range" min="20" max="80">
      <br>
      <span>(보정 단계를 높일수록 선이 부드러워지고 무게를 높일수록 천천히 그려집니다)</span>
    </div>
    <br>
    <div id="brush-shelf">
      <span>지우개: </span>
      <input id="select-eraser-checkbox" type="checkbox">
      <span>브러시 크기: </span>
      <input id="brush-size-slider" type="range" min="1" max="100">
      <span>흐름: </span>
      <input id="brush-flow-slider" type="range" min="0" max="100">
      <span>간격: </span>
      <input id="brush-interval-slider" type="range" min="0" max="1000">
    </div>
    <div id="brush-image-shelf">
      <div class="brush-image on" id="circle-brush"></div>
      <img src="./img/brush/b0.png" class="brush-image"></img>
      <img src="./img/brush/b1.png" class="brush-image"></img>
      <img src="./img/brush/b2.png" class="brush-image"></img>
      <img src="./img/brush/b3.png" class="brush-image"></img>
      <img src="./img/brush/b4.png" class="brush-image"></img>
    </div>
    <div id="canvas-area">
      <object id="tablet-api" type="application/x-wacomtabletplugin"></object>
    </div>
    <div id="color-picker">
      <div id="color-picker-sb">
        <div id="color-picker-white"></div>
        <div id="color-picker-saturate"></div>
        <div id="color-picker-brightness"></div>
        <div id="color-picker-thumb"></div>
      </div>
      <span>색조: </span>
      <input id="color-picker-hue-slider" type="range" min="0" max="360">
      <br>
      <span>투명도: </span>
      <input id="brush-opacity-slider" type="range" min="0" max="100">
      <br>
      <span>현재 색상: </span>
      <div id="color-picker-checker">
        <p id="color-picker-color"></p>
      </div>
    </div>
    <p>필압이 적용되지 않는다면
      <a href="http://www.wacomkorea.com/download/wacom_download1.php" target="_blank">
        최신 버전의 타블렛 드라이버</a>를 설치해보시기 바랍니다.</p>
    <script src="./TinyColor/tinycolor.js"></script>
    <script src="./croquispop.js"></script>
    <script>
    // <![CDATA[
    var colorPickerHueSlider = document.getElementById('color-picker-hue-slider');
    var colorPickerSb = document.getElementById('color-picker-sb');
    var colorPickerSaturate = document.getElementById('color-picker-saturate');
    var colorPickerThumb = document.getElementById('color-picker-thumb');
    colorPickerHueSlider.value = tinycolor(croquis.getToolColor()).toHsv().h;

    function setColor() {
      var halfThumbRadius = 7.5;
      var sbSize = 150;
      var h = colorPickerHueSlider.value;
      var s = parseFloat(colorPickerThumb.style.getPropertyValue('margin-left'));
      var b = parseFloat(colorPickerThumb.style.getPropertyValue('margin-top'));
      s = (s + halfThumbRadius) / sbSize;
      b = 1 - ((b + halfThumbRadius + sbSize) / sbSize);
      croquis.setToolColor(tinycolor({h: h, s:s, v: b}).toRgbString());
      var a = croquis.getToolOpacity();
      var color = tinycolor({h: h, s:s, v: b, a: a});
      colorPickerColor.style.backgroundColor = color.toRgbString();
      colorPickerColor.textContent = color.toHexString();
    }

    colorPickerHueSlider.onchange = function () {
      var hue = colorPickerHueSlider.value;
      colorPickerSaturate.style.setProperty('background-image',
        'linear-gradient(to right, hsla(' +
        hue + ', 100%, 50%, 0), hsl(' + hue + ', 100%, 50%))');
      setColor();
    }

    function colorPickerMouseDown(e) {
      document.addEventListener('mousemove', colorPickerMouseMove);
      colorPickerMouseMove(e);
    }
    function colorPickerMouseUp(e) {
      document.removeEventListener('mousemove', colorPickerMouseMove);
    }
    function colorPickerMouseMove(e) {
      var boundRect = colorPickerSb.getBoundingClientRect();
      var x = (e.clientX - boundRect.left);
      var y = (e.clientY - boundRect.top);
      pickColor(x, y);
    }
    function minmax(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }
    function pickColor(x, y) {
      var halfThumbRadius = 7.5;
      var sbSize = 150;
      colorPickerThumb.style.setProperty('margin-left',
        (minmax(x, 0, sbSize) - halfThumbRadius) + 'px');
      colorPickerThumb.style.setProperty('margin-top',
        (minmax(y, 0, sbSize) - (sbSize + halfThumbRadius)) + 'px');
      colorPickerThumb.style.setProperty('border-color',
        (y < sbSize * 0.5)? '#000' : '#fff');
      setColor();
    }
    colorPickerSb.addEventListener('mousedown', colorPickerMouseDown);
    document.addEventListener('mouseup', colorPickerMouseUp);

    var colorPickerChecker = document.getElementById('color-picker-checker');
    colorPickerChecker.style.backgroundImage = 'url(' +
      croquis.getBackgroundCheckerImage().toDataURL() + ')';
    var colorPickerColor = document.getElementById('color-picker-color');

    pickColor(0, 150);

    var toolStabilizeLevelSlider = document.getElementById('tool-stabilize-level-slider');
    var toolStabilizeWeightSlider = document.getElementById('tool-stabilize-weight-slider');
    toolStabilizeLevelSlider.value = croquis.getToolStabilizeLevel();
    toolStabilizeWeightSlider.value = croquis.getToolStabilizeWeight() * 100;

    var selectEraserCheckbox = document.getElementById('select-eraser-checkbox');
    var brushSizeSlider = document.getElementById('brush-size-slider');
    var brushOpacitySlider = document.getElementById('brush-opacity-slider');
    var brushFlowSlider = document.getElementById('brush-flow-slider');
    var brushIntervalSlider = document.getElementById('brush-interval-slider');
    brushSizeSlider.value = croquis.getToolSize();
    brushOpacitySlider.value = croquis.getToolOpacity() * 100;
    brushFlowSlider.value = croquis.getBrushFlow() * 100;
    brushIntervalSlider.value = croquis.getBrushInterval() * 100;

    toolStabilizeLevelSlider.onchange = function () {
      croquis.setToolStabilizeLevel(toolStabilizeLevelSlider.value);
      toolStabilizeLevelSlider.value = croquis.getToolStabilizeLevel();
    }
    toolStabilizeWeightSlider.onchange = function () {
      croquis.setToolStabilizeWeight(toolStabilizeWeightSlider.value * 0.01);
      toolStabilizeWeightSlider.value = croquis.getToolStabilizeWeight() * 100;
    }

    selectEraserCheckbox.onchange = function () {
      croquis.setTool(selectEraserCheckbox.checked? 'eraser' : 'brush');
    }
    brushSizeSlider.onchange = function () {
      croquis.setToolSize(brushSizeSlider.value);
    }
    brushOpacitySlider.onchange = function () {
      croquis.setToolOpacity(brushOpacitySlider.value * 0.01);
      setColor();
    }
    brushFlowSlider.onchange = function () {
      croquis.setBrushFlow(brushFlowSlider.value * 0.01);
    }
    brushIntervalSlider.onchange = function () {
      croquis.setBrushInterval(brushIntervalSlider.value * 0.01);
    }
    // ]]>
    </script>
    </script>
  </body>
</html>